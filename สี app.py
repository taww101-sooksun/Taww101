import streamlit as st
import firebase_admin
from firebase_admin import credentials, db
import datetime

# 1. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase (‡πÉ‡∏ä‡πâ‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô Secrets)
if not firebase_admin._apps:
    # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON ‡∏à‡∏≤‡∏Å Streamlit Secrets
    fb_conf = st.secrets["firebase"]
    creds = credentials.Certificate(dict(fb_conf))
    firebase_admin.initialize_app(creds, {
        'databaseURL': 'https://console.firebase.google.com/u/0/project/notty-101/database/notty-101-default-rtdb/data/~2F?hl=th-TH/' # ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á DB ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
    })

st.title("üåê SYNAPSE - Music Therapy")

# ‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏ù‡∏±‡πà‡∏á (‡∏ù‡∏±‡πà‡∏á‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ ‡∏Å‡∏±‡∏ö ‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏£‡∏≤‡∏î‡∏π)
tab1, tab2 = st.tabs(["üöÄ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô", "üìä Dashboard ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤"])

with tab1:
    st.header("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì")
    user_id = st.text_input("‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:", placeholder="‡πÄ‡∏ä‡πà‡∏ô A001")
    
    if st.button("Start Journey"):
        if user_id:
            # ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Timezone)
            now = datetime.datetime.now()
            current_hour = now.hour
            
                        # ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏•‡∏á (Logic) - ‡∏ï‡∏±‡∏î music/ ‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å
            if 6 <= current_hour < 12:
                song_path = "test_morning.mp3" # ‡πÑ‡∏°‡πà‡∏°‡∏µ music/ ‡πÅ‡∏•‡πâ‡∏ß
                status = "‡πÄ‡∏ä‡πâ‡∏≤‡∏≠‡∏±‡∏ô‡∏™‡∏î‡πÉ‡∏™"
            else:
                song_path = "test_evening.mp3" # ‡πÑ‡∏°‡πà‡∏°‡∏µ music/ ‡πÅ‡∏•‡πâ‡∏ß
                status = "‡πÄ‡∏¢‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢"

            # ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á
            import os
            if os.path.exists(song_path):
                st.audio(song_path)
                st.success(f"üéµ ‡πÄ‡∏à‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÇ‡∏´‡∏°‡∏î: {status}")
            else:
                st.error(f"‚ùå ‡∏¢‡∏±‡∏á‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå '{song_path}' ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠")
                # ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô GitHub ‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á
                st.write("‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠:", os.listdir("."))


            # ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô Firebase (‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á!)
            ref = db.reference(f'users/{user_id}')
            ref.set({
                'last_seen': str(now),
                'status': status,
                'song': song_path
            })

            st.success(f"‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ {now.strftime('%H:%M')}")
            st.write(f"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏≥‡∏ö‡∏±‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏´‡∏°‡∏î: **{status}**")
            
            # ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á
            st.audio(song_path)
        else:
            st.warning("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô")

with tab2:
    st.header("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÜ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î")
    # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏à‡∏≤‡∏Å Firebase ‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå
    users_ref = db.reference('users').get()
    if users_ref:
        st.table(users_ref) # ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡πÄ‡∏•‡∏¢
    else:
        st.write("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö")

